---
import { useTranslations } from "../i18n/utils";

// Get current language from Astro params
const { lang } = Astro.params;
const currentLang = (lang || "fr") as "fr" | "en";
const t = useTranslations(currentLang);

// Inline settings (migrated from Shopify schema)
const settings = {
    video_url:
        "https://cdn.shopify.com/videos/c/o/v/8994718215264acaa4a71d9cc2d07499.mp4",
    reel_link: "#",
    heading: "Des créations visuelles <br> à votre image",
    subtitle: "NOTRE CRÉATIVITÉ À VOTRE SERVICE",
    show_scroll_indicator: true,
};
---

<!-- Hero Video Section -->
<section
    class="relative w-full h-screen flex! items-stretch! justify-center"
    data-section-type="hero-video"
    id="hero-container"
>
    <div
        class="w-full sm:w-auto mx-0 sm:mx-8 mt-12 flex! flex-col! items-center justify-center z-59!!"
        data-hero-video-container
    >
        <div
            data-hero-video-wrapper
            class="relative overflow-hidden z-40 rounded-[8px]! sm:rounded-[12px]! lg:rounded-[24px]! w-full h-[300px] sm:w-[300px] sm:h-[200px] min-w-[300px] min-h-[200px] lg:min-w-[406px] lg:min-h-[252px] xl:min-w-[504px] xl:min-h-[284px] shadow-2xl"
            style="container-type: inline-size;"
        >
            <video
                class="w-full h-full object-cover aspect-4/3"
                autoplay
                loop
                muted
                playsinline
                data-hero-video
            >
                <source src={settings.video_url} type="video/mp4" />
                Your browser does not support the video tag.
            </video>

            <!-- Heading and Subtitle inside video wrapper -->
            <div
                class="absolute bottom-0 left-0 right-0 flex items-end justify-between opacity-0 ps-1! md:ps-2! lg:ps-4! pe-1! md:pe-2! lg:pe-4!"
                data-hero-heading
            >
                <div
                    class="flex flex-col items-start gap-0 text-left w-[75%] max-w-[300px] md:max-w-[600px] lg:max-w-[800px] xl:max-w-[1000px]"
                >
                    <h1
                        class="font-['Montserrat']! font-medium! text-white uppercase leading-[1.3]! md:leading-[1.26]! drop-shadow-lg m-0! p-0! text-[6cqw]! sm:text-[3cqw]! lg:text-[4cqw]!"
                        set:html={settings.heading}
                    />
                </div>

                <!-- Voir le reel link - bottom right -->
                <a
                    href={settings.reel_link}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="flex flex-col items-end justify-end gap-0"
                    data-reel-button
                >
                    <svg
                        class="text-white w-[10cqw] h-[10cqw] sm:w-[7cqw] sm:h-[7cqw] lg:w-[9cqw] lg:h-[9cqw]"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <line x1="7" y1="17" x2="17" y2="7"></line>
                        <polyline points="7 7 17 7 17 17"></polyline>
                    </svg>
                    <p
                        class="font-['Montserrat']! font-semibold! leading-none! text-white text-center whitespace-nowrap m-0! p-0! mb-1! text-[3cqw] sm:text-[1.5cqw] lg:text-[2cqw]"
                    >
                        {t("general.hero_video.view_reel")}
                    </p>
                </a>
            </div>
        </div>
    </div>

    {
        settings.show_scroll_indicator && (
            <div class="absolute bottom-4">
                <div
                    class="flex flex-col items-center gap-2 animate-bounce pointer-events-none"
                    data-hero-scroll-indicator
                >
                    <p class="font-medium text-[#083D45] text-xs md:text-sm lg:text-base xl:text-lg font-['Montserrat']!">
                        Scroll
                    </p>
                    <svg
                        class="w-3 h-3 md:w-4 md:h-4 lg:w-5 lg:h-5 xl:w-6 xl:h-6 text-[#083D45]"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M19 14l-7 7m0 0l-7-7m7 7V3"
                        />
                    </svg>
                </div>
            </div>
        )
    }
</section>

<script>
    import gsap from "gsap";
    import { ScrollTrigger } from "gsap/ScrollTrigger";

    // Register ScrollTrigger plugin
    gsap.registerPlugin(ScrollTrigger);

    // // Disable browser scroll restoration to prevent flash
    // if ("scrollRestoration" in history) {
    //     history.scrollRestoration = "manual";
    // }

    // Store scroll position before page unload
    // let savedScrollPosition: number | null = null;
    // if (sessionStorage.getItem("scrollPosition")) {
    //     savedScrollPosition = parseInt(
    //         sessionStorage.getItem("scrollPosition")!,
    //         10,
    //     );
    // }

    // Save scroll position before navigating away
    // window.addEventListener("beforeunload", function () {
    //     sessionStorage.setItem(
    //         "scrollPosition",
    //         String(window.pageYOffset || document.documentElement.scrollTop),
    //     );
    // });

    document.addEventListener("DOMContentLoaded", function () {
        let resizeTimeout: number;

        // Initialize hero video animation
        function initHeroVideoAnimation() {
            const videoWrapper = document.querySelector(
                "[data-hero-video-wrapper]",
            ) as HTMLElement;
            const videoContainer = document.querySelector(
                "[data-hero-video-container]",
            ) as HTMLElement;
            const heroSection = document.querySelector(
                '[data-section-type="hero-video"]',
            ) as HTMLElement;

            if (!videoWrapper || !videoContainer || !heroSection) return;

            // Kill existing ScrollTriggers for this section
            ScrollTrigger.getAll().forEach((trigger) => {
                if (
                    trigger.trigger === heroSection ||
                    trigger.trigger === videoWrapper
                ) {
                    trigger.kill();
                }
            });

            // Create a timeline for the video growth animation
            const tl = gsap.timeline({
                scrollTrigger: {
                    trigger: heroSection,
                    start: "top top",
                    end: "+=1400", // Animation happens over 1400px of scroll
                    scrub: 1, // Smoother scrubbing effect
                    pin: true, // Pin the video container
                    pinSpacing: true, // Keep spacing after pin
                    anticipatePin: 1,
                    markers: false, // Set to true for debugging
                },
            });

            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            const isMobile = windowWidth <= 640;

            let initialHeight: number,
                targetHeight: number,
                initialWidth: number,
                targetWidth: number;

            if (isMobile) {
                // Mobile: Keep full width, only grow in height
                initialHeight = 300; // Starting height from CSS
                targetHeight = windowHeight * 0.9; // Grow to 90% of viewport height

                tl.to(videoWrapper, {
                    height: targetHeight,
                    duration: 1,
                    ease: "power2.out",
                });
            } else {
                // Desktop/Tablet: Grow in width and height
                if (windowWidth >= 1280) {
                    initialWidth = 504;
                    initialHeight = 284;
                } else if (windowWidth >= 1024) {
                    initialWidth = 406;
                    initialHeight = 252;
                } else if (windowWidth >= 640) {
                    initialWidth = 300;
                    initialHeight = 200;
                }

                // Calculate aspect ratio from initial dimensions
                const aspectRatio = initialWidth! / initialHeight!;

                // Calculate maximum available space with padding
                const maxWidth = windowWidth - 64; // 64px total padding on desktop
                const maxHeight = windowHeight * 0.9; // Use 90% of viewport height

                // Determine target dimensions based on available space and aspect ratio
                targetWidth = maxWidth;
                targetHeight = targetWidth / aspectRatio;

                // If height exceeds max, constrain by height instead
                if (targetHeight > maxHeight) {
                    targetHeight = maxHeight;
                    targetWidth = targetHeight * aspectRatio;
                }

                // Animate the video wrapper to grow using width and height
                tl.to(videoWrapper, {
                    width: targetWidth,
                    height: targetHeight,
                    duration: 1,
                    ease: "power2.out",
                });
            }

            // Fade in heading as video grows (at the same time)
            tl.to(
                "[data-hero-heading]",
                {
                    opacity: 1,
                    duration: 1,
                    ease: "linear",
                },
                0,
            ); // Start at the beginning of the timeline (position 0)

            gsap.to("[data-hero-scroll-indicator]", {
                opacity: 0,
                scrollTrigger: {
                    trigger: videoWrapper,
                    start: "top top",
                    end: "+=50",
                    scrub: 1,
                },
            });

            // // Refresh ScrollTrigger after initialization to ensure proper positioning
            // ScrollTrigger.refresh();

            // // Restore scroll position after ScrollTrigger is ready (prevents flash)
            // if (savedScrollPosition !== null && savedScrollPosition > 0) {
            //     // Use requestAnimationFrame to ensure DOM is fully ready
            //     requestAnimationFrame(function () {
            //         requestAnimationFrame(function () {
            //             window.scrollTo(0, savedScrollPosition);
            //             // Clear saved position after restoring
            //             sessionStorage.removeItem("scrollPosition");
            //         });
            //     });
            // }
        }

        // Initialize on page load
        initHeroVideoAnimation();

        // Debounced resize handler to reinitialize animations
        window.addEventListener("resize", function () {
            clearTimeout(resizeTimeout);
            resizeTimeout = window.setTimeout(function () {
                initHeroVideoAnimation();
            }, 250); // Wait 250ms after resize stops before reinitializing
        });
    });
</script>
