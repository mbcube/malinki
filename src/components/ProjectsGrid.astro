---
import ProjectCard from "./ProjectCard.astro";
import projectsGrid from "../data/projects-grid.json";

interface Props {
  lang?: "fr" | "en";
}

const { lang = "fr" } = Astro.props;
const { grids } = projectsGrid;
---

<!-- Projects Grid Section -->
<section
  class="relative w-full font-['Montserrat'] mt-12 md:mt-16 lg:mt-20 mb-3"
  data-section-type="projects-grid"
  id="projects"
>
  <div>
    {
      grids.map((grid) => (
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 auto-rows-fr mb-3">
          {grid.projects.map((project) => (
            <ProjectCard
              imageFile={project.imageFile}
              videoUrl={project.videoUrl}
              altText={project.altText}
              clientName={project.clientName}
              agencyName={project.agencyName}
              width={project.width}
              height={project.height}
              containerClasses={project.containerClasses}
              projectSlug={project.projectSlug}
              lang={lang}
            />
          ))}
        </div>
      ))
    }
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Get all project cards with video
    const projectCards = document.querySelectorAll("[data-project-card]");

    projectCards.forEach((card) => {
      const video = card.querySelector(
        "[data-video-hover]"
      ) as HTMLVideoElement;

      if (video) {
        // Extract start time from data attribute (original URL with time fragment)
        const originalUrl = video.getAttribute("data-video-url");
        let startTime = 0;

        if (originalUrl && originalUrl.includes("#t=")) {
          const timeFragment = originalUrl.split("#t=")[1];
          // Handle formats like "10" (seconds) or "1:30" (minutes:seconds)
          if (timeFragment.includes(":")) {
            const parts = timeFragment.split(":");
            startTime = parseInt(parts[0]) * 60 + parseFloat(parts[1]);
          } else {
            startTime = parseFloat(timeFragment);
          }
        }

        // Preload metadata to prevent jump on first hover
        video.load();

        // Play video on hover
        card.addEventListener("mouseenter", function () {
          video.currentTime = startTime; // Start at specified time
          const playPromise = video.play();

          // Handle play promise for better error handling
          if (playPromise !== undefined) {
            playPromise.catch((error) => {
              // Auto-play was prevented, video will show poster
              console.log("Video autoplay prevented:", error);
            });
          }
        });

        // Pause and reset video when hover ends
        card.addEventListener("mouseleave", function () {
          video.pause();
          video.currentTime = startTime; // Reset to start time
          // Force reload to show poster image again
          video.load();
        });
      }
    });
  });
</script>
